import { Injectable, OnModuleInit } from '@nestjs/common';
import { SessionService } from '../session/session.service';

@Injectable()
export class WhatsappService implements OnModuleInit {
  private attendant_id: string;
  constructor(private sessionService: SessionService) {}

  async onModuleInit() {
    if (this.attendant_id) {
      this.handleIncomingMessages(this.attendant_id);
    }
  }

  async createSession(attendantId: string) {
    await this.sessionService.createSession(attendantId);
    this.attendant_id = attendantId;
  }

  async closeSession(attendantId: string) {
    this.sessionService.closeSession(attendantId);
  }

  async sendMessage(
    userNumber: string,
    textMessage: string,
    attendantId: string,
  ) {
    const client = this.sessionService.getClient(attendantId);

    if (!client) throw new Error('Session not found');

    try {
      const formattedNumber = userNumber.includes('@s.whatsapp.net')
        ? userNumber
        : `${userNumber}@s.whatsapp.net`;

      await client.sendMessage(formattedNumber, { text: textMessage });
      console.log(`Mensagem enviada para o atendente: ${formattedNumber}`);
    } catch (error) {
      console.error(`Erro ao enviar mensagem para o atendente:`, error);
      throw error;
    }
  }

  async handleIncomingMessages(attendantId: string) {
    const client = this.sessionService.getClient(attendantId);

    if (!client) throw new Error('Session not found');

    client.ev.on('messages.upsert', async (msg) => {
      if (msg.type === 'notify') {
        for (const message of msg.messages) {
          if (!message.message) continue;

          const sender = message.key.remoteJid!;
          const messageType = this.getMessageType(message);

          if (messageType === 'conversation') {
            const text = message.message.conversation.trim();

            if (text === '5') {
              // "Falar com um atendente"
              await this.sendMessage(
                sender,
                `O usuÃ¡rio ${sender} precisa de suporte.`,
                attendantId,
              );

              await client.sendMessage(sender, {
                text: 'âœ… Sua solicitaÃ§Ã£o foi enviada para um atendente. Aguarde o retorno!',
              });
            } else {
              // Processar mensagem do menu
              await this.handleUserMessage(client, sender, text);
            }
          } else if (messageType === 'image') {
            await client.sendMessage(sender, {
              text: 'ğŸ“· Recebi sua imagem. Deseja mais informaÃ§Ãµes?',
            });
          } else if (messageType === 'video') {
            await client.sendMessage(sender, {
              text: 'ğŸ¥ Recebi seu vÃ­deo. Deseja mais informaÃ§Ãµes?',
            });
          } else if (messageType === 'document') {
            await client.sendMessage(sender, {
              text: 'ğŸ“„ Recebi seu arquivo. Deseja mais informaÃ§Ãµes?',
            });
          } else {
            await client.sendMessage(sender, {
              text: 'â“ NÃ£o consegui entender. Tente enviar uma mensagem de texto.',
            });
          }
        }
      }
    });
  }

  private async handleUserMessage(
    client: any,
    sender: string,
    message: string,
  ) {
    const menu = `ğŸ‘‹ OlÃ¡! Eu sou seu assistente. Como posso te ajudar?
    1ï¸âƒ£ InformaÃ§Ãµes
    2ï¸âƒ£ Solicitar FormulÃ¡rios
    3ï¸âƒ£ Pesquisar
    4ï¸âƒ£ Perguntas Frequentes
    5ï¸âƒ£ Falar com um atendente`;

    let reply = '';

    switch (message) {
      case '1':
        reply = 'ğŸ“š Aqui estÃ£o as informaÃ§Ãµes sobre os cursos disponÃ­veis!';
        break;
      case '2':
        reply =
          'ğŸ“„ Aqui estÃ¡ o link para solicitar formulÃ¡rios: https://ufsc.br/formularios';
        break;
      case '3':
        reply = 'ğŸ” Digite sua dÃºvida que eu tentarei ajudar.';
        break;
      case '4':
        reply = 'ğŸ’¬ Veja as perguntas frequentes em https://ufsc.br/faq';
        break;
      default:
        reply = menu;
    }

    await client.sendMessage(sender, { text: reply });
  }

  private getMessageType(message: any): string {
    if (message.message?.conversation) return 'conversation';
    if (message.message?.imageMessage) return 'image';
    if (message.message?.videoMessage) return 'video';
    if (message.message?.documentMessage) return 'document';
    return 'unknown';
  }
}
